---
# tests/cluster-health file for k3s_tests
- name: "K3S Tests | Cluster Health | Test k3s cluster nodes"
  block:
    - name: "K3S Tests | Cluster Health | Get k3s cluster nodes"
      kubernetes.core.k8s_info:
        kind: Node
        kubeconfig: "{{ k3s_tests_kubeconfig_path }}"
      delegate_to: "{{ k3s_tests_delegation_target }}"
      run_once: true
      register: _k3s_tests_cluster_nodes

    - name: "K3S Tests | Cluster Health | Verify k3s cluster nodes"
      vars:
        _k3s_tests_node_count_check: >-
          {{
            k3s_tests_expected_node_count > 0 and
            _k3s_tests_cluster_nodes.resources | length == k3s_tests_expected_node_count
          }}
        _k3s_tests_node_exists_check: >-
          {{
            k3s_tests_expected_node_count == 0 and
            _k3s_tests_cluster_nodes.resources | length > 0
          }}
      ansible.builtin.assert:
        that:
          - _k3s_tests_node_count_check or _k3s_tests_node_exists_check
          - _k3s_tests_cluster_nodes.resources[0].status.conditions | selectattr('type', 'equalto', 'Ready') | selectattr('status', 'equalto', 'True') | list | length > 0
        fail_msg: "K3s cluster nodes verification failed"
        success_msg: "K3s cluster nodes verified successfully"
