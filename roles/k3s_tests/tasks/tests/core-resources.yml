---
# tests/core-resources file for k3s_tests
- name: "K3S Tests | Core Resources | Test k3s default namespaces"
  block:
    - name: "K3S Tests | Core Resources | Get k3s namespaces"
      kubernetes.core.k8s_info:
        kind: Namespace
        kubeconfig: "{{ k3s_tests_kubeconfig_path }}"
      delegate_to: "{{ k3s_tests_delegation_target }}"
      run_once: true
      register: _k3s_tests_namespaces

    - name: "K3S Tests | Core Resources | Verify k3s default namespaces"
      ansible.builtin.assert:
        that:
          - _k3s_tests_namespaces.resources | selectattr('metadata.name', 'equalto', 'default') | list | length == 1
          - _k3s_tests_namespaces.resources | selectattr('metadata.name', 'equalto', 'kube-system') | list | length == 1
          - _k3s_tests_namespaces.resources | selectattr('metadata.name', 'equalto', 'kube-public') | list | length == 1
          - _k3s_tests_namespaces.resources | selectattr('metadata.name', 'equalto', 'kube-node-lease') | list | length == 1
        fail_msg: "K3s default namespaces verification failed"
        success_msg: "K3s default namespaces verified successfully"

- name: "K3S Tests | Core Resources | Test k3s core system pods"
  block:
    - name: "K3S Tests | Core Resources | Get k3s system pods"
      kubernetes.core.k8s_info:
        kind: Pod
        namespace: kube-system
        kubeconfig: "{{ k3s_tests_kubeconfig_path }}"
      delegate_to: "{{ k3s_tests_delegation_target }}"
      run_once: true
      register: _k3s_tests_system_pods

    - name: "K3S Tests | Core Resources | Verify k3s core system pods"
      ansible.builtin.assert:
        that:
          - _k3s_tests_system_pods.resources | length > 0
          - _k3s_tests_system_pods.resources | selectattr('metadata.name', 'search', 'coredns') | list | length > 0
          - _k3s_tests_system_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length > 0
        fail_msg: "K3s core system pods verification failed"
        success_msg: "K3s core system pods verified successfully"
